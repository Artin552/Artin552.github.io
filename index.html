<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–°—Ç—Ä–æ–π–ú–∞—Ä–∫–µ—Ç ‚Äî –æ–±—ä—è–≤–ª–µ–Ω–∏—è</title>
  <link rel="stylesheet" href="frontend/css/styles.css">
</head>
<body>
  <header class="header">
    <div class="top_header">
      <div class="container inner">
        <a class="logo" href="index.html">
          <span class="mark" aria-hidden="true"></span>
          <span class="text-name">BuildStore</span>
        </a>
        <div style="display:flex; gap:8px; align-items:center" id="userSection">
          <a href="frontend/auth.html" class="btn secondary" id="authBtn">–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
          <a href="frontend/add.html" class="btn">–î–æ–±–∞–≤–∏—Ç—å</a>
        </div>
      </div>
    </div>
    <div class="m_header">Market</div>
    <div class="under_header">
      <div style="flex:1; margin:0 16px;">
        <div class="search-bar">
          <input id="searchInput" placeholder="–ü–æ–∏—Å–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏–π, –Ω–∞–ø—Ä. '—ç–∫—Å–∫–∞–≤–∞—Ç–æ—Ä'">
          <button class="btn" id="searchBtn">–ü–æ–∏—Å–∫</button>
        </div>
      </div>
    </div>
  </header>

  <main class="container" style="padding-top:18px">
    <section aria-label="–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏">
      <h2>–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</h2>
      <div class="categories" id="categories">
        <div class="category">–¢–µ—Ö–Ω–∏–∫–∞</div>
        <div class="category">–¶–µ–º–µ–Ω—Ç, —Å—É—Ö–∏–µ —Å–º–µ—Å–∏</div>
        <div class="category">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</div>
        <div class="category">–ö—Ä–µ–ø–µ–∂</div>
      </div>
    </section>

    <section aria-label="–ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è">
      <h2>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è</h2>
      <div id="listings" class="grid">
        <!-- JS –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –∫–∞—Ä—Ç–æ—á–∫–∏ -->
      </div>
    </section>

    <footer class="footer">
      ¬© 2025 –°—Ç—Ä–æ–π–ú–∞—Ä–∫–µ—Ç ‚Äî —É—á–µ–±–Ω—ã–π –ø—Ä–æ–µ–∫—Ç. –í—Å–µ –ø—Ä–∞–≤–∞ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∞—Ç –∞–≤—Ç–æ—Ä—É –ø—Ä–æ–µ–∫—Ç–∞.
    </footer>
  </main>

  <script>
    // üîπ –ü–æ–∫–∞–∑—ã–≤–∞–µ–º email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤–º–µ—Å—Ç–æ –∫–Ω–æ–ø–∫–∏ –≤—Ö–æ–¥–∞
    document.addEventListener('DOMContentLoaded', () => {
      const authBtn = document.getElementById('authBtn');
      const userEmail = sessionStorage.getItem('userEmail');
      if (userEmail) {
        authBtn.textContent = userEmail;
        authBtn.href = '#';
        authBtn.addEventListener('click', () => {
          sessionStorage.removeItem('userEmail');
          window.location.reload();
        });
      }
    });

    // üîπ –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–π
    async function loadListings(q = '') {
      const root = document.getElementById('listings');
      root.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';
      try {
        const res = await fetch('http://localhost:5000/api/listings' + (q ? ('?q=' + encodeURIComponent(q)) : ''));
        const data = await res.json();
        if (!Array.isArray(data)) {
          root.innerText = '–û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –æ—Ç–≤–µ—Ç–∞';
          return;
        }
        if (data.length === 0) {
          root.innerHTML = '<div>–û–±—ä—è–≤–ª–µ–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç.</div>';
          return;
        }
        root.innerHTML = '';
        data.forEach(item => {
          const card = document.createElement('article');
          card.className = 'card';
          const imgUrl = item.imagePath || `https://picsum.photos/seed/${encodeURIComponent(item.title)}/400/300`;
          card.innerHTML = `
            <img class="thumb" src="${imgUrl}" alt="${item.title}">
            <div class="meta">
              <div>
                <div class="title">${item.title}</div>
                <div class="muted small">${item.category || ''} ‚Ä¢ ${item.location || ''}</div>
              </div>
              <div style="display:flex; justify-content:space-between; align-items:center;">
                <div class="price">${item.price ? item.price + ' ‚ÇΩ' : '–¶–µ–Ω–∞ –ø–æ –¥–æ–≥–æ–≤–æ—Ä—ë–Ω–Ω–æ—Å—Ç–∏'}</div>
                <a class="btn secondary" href="listings.html?id=${item.id}">–û—Ç–∫—Ä—ã—Ç—å</a>
              </div>
            </div>
          `;
          root.appendChild(card);
        });
      } catch (e) {
        root.innerText = '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏—è.';
        console.error(e);
      }
    }

    document.getElementById('searchBtn').addEventListener('click', () => {
      loadListings(document.getElementById('searchInput').value.trim());
    });

    // üîπ –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    loadListings();
  </script>
</body>
</html>
