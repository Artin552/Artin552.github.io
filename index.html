<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–°—Ç—Ä–æ–π–ú–∞—Ä–∫–µ—Ç ‚Äî –æ–±—ä—è–≤–ª–µ–Ω–∏—è</title>
  <link rel="stylesheet" href="frontend/css/styles.css">
</head>
<body>
  <header class="header">
    <div class="top_header">
      <div class="container inner">
        <a class="logo" href="index.html">
          <span class="mark" aria-hidden="true"></span>
          <span class="text-name">BuildStore</span>
        </a>
        <div style="display:flex; gap:8px; align-items:center" id="userSection">
          <a href="frontend/auth.html" class="btn secondary" id="authBtn">–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
          <a href="frontend/add.html" class="btn">–î–æ–±–∞–≤–∏—Ç—å</a>
        </div>
        
      </div>
    </div>
    <div class="m_header">Market</div>
    <div class="under_header">
      <div style="flex:1; margin:0 16px;">
        <div class="search-bar">
          <input id="searchInput" placeholder="–ü–æ–∏—Å–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏–π, –Ω–∞–ø—Ä. '—ç–∫—Å–∫–∞–≤–∞—Ç–æ—Ä'">
          <button class="btn" id="searchBtn">–ü–æ–∏—Å–∫</button>
        </div>
      </div>
    </div>
  </header>

  <main class="container" style="padding-top:18px">
    <section aria-label="–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏">
      <h2>–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</h2>
      <div class="categories" id="categories">
        <div class="category">–¢–µ—Ö–Ω–∏–∫–∞</div>
        <div class="category">–¶–µ–º–µ–Ω—Ç, —Å—É—Ö–∏–µ —Å–º–µ—Å–∏</div>
        <div class="category">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</div>
        <div class="category">–ö—Ä–µ–ø–µ–∂</div>
      </div>
    </section>

    <section aria-label="–ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è">
      <h2>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è</h2>
      <div id="listings" class="grid">
        <!-- JS –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –∫–∞—Ä—Ç–æ—á–∫–∏ -->
      </div>
    </section>

    <footer class="footer">
      ¬© 2025 –°—Ç—Ä–æ–π–ú–∞—Ä–∫–µ—Ç ‚Äî —É—á–µ–±–Ω—ã–π –ø—Ä–æ–µ–∫—Ç. –í—Å–µ –ø—Ä–∞–≤–∞ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∞—Ç –∞–≤—Ç–æ—Ä—É –ø—Ä–æ–µ–∫—Ç–∞.
    </footer>
  </main>

  <script>
    // üîπ –ü–æ–∫–∞–∑—ã–≤–∞–µ–º email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤–º–µ—Å—Ç–æ –∫–Ω–æ–ø–∫–∏ –≤—Ö–æ–¥–∞ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –≤—ã—Ö–æ–¥
    document.addEventListener('DOMContentLoaded', () => {
      const userSection = document.getElementById('userSection');
      const authBtn = document.getElementById('authBtn');
      const userEmail = sessionStorage.getItem('userEmail');

      if (userEmail) {
        // –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ä—É—é –∫–Ω–æ–ø–∫—É
        authBtn.style.display = 'none';

        // –°–æ–∑–¥–∞—ë–º —Å—Å—ã–ª–∫—É –Ω–∞ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç
        const profileLink = document.createElement('a');
        profileLink.className = 'btn secondary';
        profileLink.href = 'frontend/dashboard.html';
        profileLink.textContent = userEmail;

        // –ö–Ω–æ–ø–∫–∞ –≤—ã—Ö–æ–¥–∞
        const logoutBtn = document.createElement('button');
        logoutBtn.className = 'btn';
        logoutBtn.textContent = '–í—ã–π—Ç–∏';
        logoutBtn.addEventListener('click', () => {
          sessionStorage.removeItem('userEmail');
          sessionStorage.removeItem('token');
          // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –æ—á–∏—Å—Ç–∏—Ç—å localStorage –µ—Å–ª–∏ —Ç–∞–º –µ—Å—Ç—å —Ç–æ–∫–µ–Ω
          localStorage.removeItem('token');
          window.location.reload();
        });

        userSection.insertBefore(profileLink, userSection.firstChild);
        userSection.insertBefore(logoutBtn, userSection.firstChild.nextSibling);
      }
    });

    // üîπ –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–π
    async function loadListings(q = '') {
      const root = document.getElementById('listings');
      // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–∏–Ω–∏-–∞–Ω–∏–º–∞—Ü–∏—é –∑–∞–≥—Ä—É–∑–∫–∏
      root.innerHTML = `
        <div style="display:flex;justify-content:center;padding:24px;">
          <div class="boxes" aria-hidden="true">
            <div class="box"><div></div><div></div><div></div><div></div></div>
            <div class="box"><div></div><div></div><div></div><div></div></div>
            <div class="box"><div></div><div></div><div></div><div></div></div>
            <div class="box"><div></div><div></div><div></div><div></div></div>
          </div>
        </div>
      `;
      try {
  const res = await fetch('/api/listings' + (q ? ('?q=' + encodeURIComponent(q)) : ''));
        const data = await res.json();
        if (!Array.isArray(data)) {
          root.innerText = '–û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –æ—Ç–≤–µ—Ç–∞';
          return;
        }
        if (data.length === 0) {
          root.innerHTML = '<div>–û–±—ä—è–≤–ª–µ–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç.</div>';
          return;
        }
        root.innerHTML = '';
        data.forEach(item => {
          const card = document.createElement('article');
          card.className = 'card';
          const imgUrl = item.imagePath || `https://picsum.photos/seed/${encodeURIComponent(item.title)}/400/300`;
          card.innerHTML = `
            <img class="thumb" src="${imgUrl}" alt="${item.title}">
            <div class="meta">
              <div>
                <div class="title">${item.title}</div>
                <div class="muted small">${item.category || ''} ‚Ä¢ ${item.location || ''}</div>
              </div>
              <div style="display:flex; justify-content:space-between; align-items:center;">
                <div class="price">${item.price ? item.price + ' ‚ÇΩ' : '–¶–µ–Ω–∞ –ø–æ –¥–æ–≥–æ–≤–æ—Ä—ë–Ω–Ω–æ—Å—Ç–∏'}</div>
                <a class="btn secondary" href="frontend/listings.html?id=${item.id}">–û—Ç–∫—Ä—ã—Ç—å</a>
              </div>
            </div>
          `;
          root.appendChild(card);
        });
      } catch (e) {
        root.innerText = '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏—è.';
        console.error(e);
      }
    }

    // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Enter –≤ –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞
    const searchInput = document.getElementById('searchInput');
    searchInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        const q = searchInput.value.trim();
        // –æ–±–Ω–æ–≤–ª—è–µ–º url –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
        history.replaceState(null, '', q ? ('?q=' + encodeURIComponent(q)) : window.location.pathname);
        loadListings(q);
      }
    });

    document.getElementById('searchBtn').addEventListener('click', () => {
      const q = document.getElementById('searchInput').value.trim();
      history.replaceState(null, '', q ? ('?q=' + encodeURIComponent(q)) : window.location.pathname);
      loadListings(q);
    });

    // –ü–æ –∫–ª–∏–∫—É –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ‚Äî –¥–µ–ª–∞–µ–º –ø–æ–∏—Å–∫ –ø–æ –Ω–µ–π
    document.querySelectorAll('.category').forEach(el => {
      el.addEventListener('click', () => {
        const q = el.textContent.trim();
        searchInput.value = q;
        history.replaceState(null, '', '?q=' + encodeURIComponent(q));
        loadListings(q);
      });
    });

    // –ï—Å–ª–∏ –≤ URL –µ—Å—Ç—å q –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ ‚Äî –∑–∞–ø–æ–ª–Ω–∏–º –ø–æ–ª–µ –∏ –≤—ã–ø–æ–ª–Ω–∏–º –ø–æ–∏—Å–∫
    const initParams = new URLSearchParams(window.location.search);
    const initQ = initParams.get('q');
    if (initQ) {
      searchInput.value = initQ;
      loadListings(initQ);
    }

    // üîπ –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    loadListings();
  </script>
  
</body>
</html>
