<!-- listings.html
   Показ всех объявлений с возможностью фильтра/категорий.
-->
<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Список объявлений — СтройМаркет</title>
  <link rel="stylesheet" href="/css/styles.css">
    <script>
      // include shared auth helper
    </script>
  <script src="/js/auth.js"></script>
</head>
<body>
  <header class="header">
    <div class="container inner">
  <a class="logo" href="/index.html"><span class="mark"></span>СтройМаркет</a>
      <div style="flex:1; margin:0 16px;">
        <div class="search-bar">
          <input id="searchInput" placeholder="Поиск по объявлениям">
          <button class="btn" id="searchBtn">Поиск</button>
        </div>
      </div>
      <div style="display:flex; gap:8px; align-items:center">
  <a href="/frontend/auth.html" class="btn secondary">Вход</a>
  <a href="/frontend/add.html" class="btn">Добавить</a>
      </div>
    </div>
  </header>

  <main class="container" style="padding-top:18px">
    <!-- Categories tiles (moved from index) -->
    <section aria-label="Категории" class="categories-section" id="categoriesSection">
      <h2>Категории</h2>
      <div id="categoryTiles" class="category-tiles">
        <!-- fallback tiles -->
        <button class="category-tile" data-cat="">Все</button>
      </div>
    </section>

    <section aria-label="Результаты и фильтры">
      <div class="results-grid" id="resultsGrid" hidden>
        <aside class="filters-panel" id="filtersPanel" aria-label="Фильтры">
          <h3>Фильтры</h3>
          <div class="filter-group"><label><input type="checkbox" id="fInStock"> В наличии</label></div>
          <div class="filter-group"><label><input type="checkbox" id="fDiscount"> Только со скидкой</label></div>
          <div class="filter-group"><label>Минимальный рейтинг</label><select id="fRating"><option value="0">Любой</option><option value="3">≥ 3</option><option value="4">≥ 4</option></select></div>
          <div class="filter-group"><label>Цена (макс)</label><input type="number" id="fMaxPrice" placeholder="Максимум"></div>
          <div style="margin-top:12px; display:flex; gap:8px"><button class="btn" id="clearFilters">Сбросить</button><button class="btn primary" id="applyFilters">Применить</button></div>
        </aside>
        <main class="results-main">
          <h2 class="sr">Объявления</h2>
          <div id="listings" class="grid"></div>
        </main>
      </div>
    </section>
    <footer class="footer">© 2025 СтройМаркет</footer>
  </main>

<script>
  // Если в URL есть id — показываем одну карточку, иначе список
  let __page = 1; const __limit = 12;
  async function loadAll(q=''){
    const root = document.getElementById('listings');
    const params = new URLSearchParams(window.location.search);
    const id = params.get('id');
    if(id){
      root.innerHTML = 'Загрузка объявления...';
      try{
        const res = await fetch('/api/listings/' + encodeURIComponent(id));
        if(!res.ok){ root.innerText = 'Объявление не найдено'; return; }
        const item = await res.json();
  const imgUrl = item.imagePath || `https://picsum.photos/seed/${encodeURIComponent(item.title)}/1200/700`;
        const created = item.created_at ? new Date(Number(item.created_at)) : null;
        const dateStr = created ? created.toLocaleDateString('ru-RU', { year:'numeric', month:'long', day:'numeric' }) : '';
        // build detail view safely using DOM APIs
        const detail = document.createElement('div'); detail.className = 'listing-detail';

        const header = document.createElement('div'); header.className = 'listing-header';
        const titleEl = document.createElement('div'); titleEl.className = 'listing-title'; titleEl.textContent = item.title || '';
        const dateEl = document.createElement('div'); dateEl.className = 'listing-date muted small'; dateEl.textContent = dateStr;
        header.appendChild(titleEl); header.appendChild(dateEl);

        const imgWrap = document.createElement('div'); imgWrap.className = 'listing-image-wrapper';
        const imgEl = document.createElement('img'); imgEl.className = 'listing-image'; imgEl.alt = item.title || ''; imgEl.src = imgUrl;
        imgEl.addEventListener('error', function onErr(){ imgEl.removeEventListener('error', onErr); imgEl.src = '/img/placeholder.svg'; });
        imgWrap.appendChild(imgEl);

        const body = document.createElement('div'); body.className = 'listing-body';
        const desc = document.createElement('div'); desc.className = 'listing-desc'; desc.textContent = item.description || '';
        const meta = document.createElement('div'); meta.className = 'listing-meta muted small'; meta.textContent = item.category || '';
        body.appendChild(desc); body.appendChild(meta);

        const cta = document.createElement('div'); cta.className = 'listing-cta';
        const ctaH = document.createElement('h3'); ctaH.textContent = 'Готовы купить?';
        const ctaP = document.createElement('p'); ctaP.className = 'muted'; ctaP.textContent = 'Свяжитесь с нами или оформите заказ онлайн.';
        const ctaBtnWrap = document.createElement('div'); ctaBtnWrap.style.marginTop = '12px';
        const ctaBtn = document.createElement('a'); ctaBtn.className = 'btn'; ctaBtn.href = '#'; ctaBtn.textContent = 'Оформить';
        ctaBtnWrap.appendChild(ctaBtn);
        cta.appendChild(ctaH); cta.appendChild(ctaP); cta.appendChild(ctaBtnWrap);

        const backWrap = document.createElement('div'); backWrap.style.textAlign = 'center'; backWrap.style.margin = '28px 0 48px';
        const backA = document.createElement('a'); backA.href = '/index.html'; backA.className = 'btn secondary'; backA.textContent = '← Назад'; backWrap.appendChild(backA);

        detail.appendChild(header);
        detail.appendChild(imgWrap);
        detail.appendChild(body);
        detail.appendChild(cta);
        detail.appendChild(backWrap);
        root.innerHTML = ''; root.appendChild(detail);
        // скрыть глобальный header для детального вида
        const pageHeader = document.querySelector('header.header');
        if(pageHeader) pageHeader.style.display = 'none';
      }catch(e){ root.innerText = 'Ошибка загрузки объявления'; }
      return;
    }

    // обычный список
    const root2 = document.getElementById('listings');
    root2.innerHTML = 'Загрузка...';
    try{
      const query = q ? (q.indexOf('?')===0? q + `&page=${__page}&limit=${__limit}` : ('?q='+encodeURIComponent(q) + `&page=${__page}&limit=${__limit}`)) : (`?page=${__page}&limit=${__limit}`);
      const res = await fetch('/api/listings' + query);
      const total = Number(res.headers.get('x-total-count') || 0);
      const data = await res.json();
      root2.innerHTML = '';
      data.forEach(item=>{
        const card = document.createElement('article'); card.className = 'card';
        const imgUrl = item.imagePath || `https://picsum.photos/seed/${encodeURIComponent(item.title)}/400/300`;
        const img = document.createElement('img'); img.className = 'thumb'; img.alt = item.title || ''; img.src = imgUrl;
        img.addEventListener('error', function onErr(){ img.removeEventListener('error', onErr); img.src = '/img/placeholder.svg'; });

        const meta = document.createElement('div'); meta.className = 'meta';
        const left = document.createElement('div');
        const title = document.createElement('div'); title.className = 'title'; title.textContent = item.title || '';
        const muted = document.createElement('div'); muted.className = 'muted small'; muted.textContent = item.category || '';
        left.appendChild(title); left.appendChild(muted);

        const right = document.createElement('div'); right.style.display = 'flex'; right.style.justifyContent = 'space-between'; right.style.alignItems = 'center';
        const price = document.createElement('div'); price.className = 'price'; price.textContent = item.price ? (item.price + ' ₽') : 'По договоренности';
        const openA = document.createElement('a'); openA.className = 'btn secondary'; openA.href = 'listings.html?id=' + encodeURIComponent(item.id); openA.textContent = 'Открыть';
        right.appendChild(price); right.appendChild(openA);

        meta.appendChild(left); meta.appendChild(right);
        card.appendChild(img); card.appendChild(meta);
        root2.appendChild(card);
      });
      // pagination controls
      const pager = document.getElementById('pager');
      if(pager) pager.remove();
  const p = document.createElement('div'); p.id='pager'; p.style.textAlign='center'; p.style.marginTop='12px';
  const totalPages = Math.max(1, Math.ceil(total / __limit));
  const prevBtn = document.createElement('button'); prevBtn.className = 'btn'; prevBtn.id = 'prevPage'; prevBtn.type = 'button'; prevBtn.textContent = '← Назад'; if(__page<=1) prevBtn.disabled = true;
  const pageInfo = document.createElement('span'); pageInfo.style.margin = '0 8px'; pageInfo.textContent = `Страница ${__page} из ${totalPages}`;
  const nextBtn = document.createElement('button'); nextBtn.className = 'btn'; nextBtn.id = 'nextPage'; nextBtn.type = 'button'; nextBtn.textContent = 'Далее →'; if(__page>=totalPages) nextBtn.disabled = true;
  p.appendChild(prevBtn); p.appendChild(pageInfo); p.appendChild(nextBtn);
  root2.parentNode.appendChild(p);
  prevBtn.addEventListener('click', ()=>{ if(__page>1){ __page--; loadAll(q); } });
  nextBtn.addEventListener('click', ()=>{ if(__page<totalPages){ __page++; loadAll(q); } });
    }catch(e){
      root2.innerText = 'Ошибка загрузки';
    }
  }
  document.getElementById('searchBtn').addEventListener('click', ()=> loadAll(document.getElementById('searchInput').value.trim()));
  // если в URL есть q — выполнить поиск или если есть cat — показать категорию
  const params = new URLSearchParams(window.location.search);
  const q = params.get('q') || '';
  const catParam = params.get('cat') || '';
  if (q) document.getElementById('searchInput').value = q;
  document.getElementById('searchBtn').addEventListener('click', ()=>{
    const qv = document.getElementById('searchInput').value.trim();
    history.replaceState(null,'', qv?('?q='+encodeURIComponent(qv)) : '');
    // show results view
    document.getElementById('resultsGrid').hidden = false;
    document.getElementById('categoriesSection').hidden = true;
    loadAll(qv);
  });
  document.getElementById('searchInput').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ const qv=document.getElementById('searchInput').value.trim(); history.replaceState(null,'', qv?('?q='+encodeURIComponent(qv)): ''); document.getElementById('resultsGrid').hidden=false; document.getElementById('categoriesSection').hidden=true; loadAll(qv); } });

  // initial view: if cat param provided, show results for that category with filters on left
  if(catParam){
    document.getElementById('resultsGrid').hidden = false;
    document.getElementById('categoriesSection').hidden = true;
    // ensure filters panel visible
    document.getElementById('filtersPanel').hidden = false;
    // load listings where q=catParam
    loadAll('?q=' + encodeURIComponent(catParam));
  } else {
    // default: show only categories
    document.getElementById('resultsGrid').hidden = true;
    document.getElementById('categoriesSection').hidden = false;
    // Populate categories without rendering all listings
    (async ()=>{
      try{
        const res = await fetch('/api/listings');
        const data = await res.json();
        window.__latestListings = data || [];
        populateCategoryTiles(window.__latestListings);
      }catch(e){ console.warn('failed to load categories', e); }
    })();
  }

  // --- Category + Filters helpers ---
  function populateCategoryTiles(listings){
    const container = document.getElementById('categoryTiles');
    if(!container) return;
    const cats = Array.from(new Set((listings||[]).map(it=>it.category).filter(Boolean)));
    container.innerHTML = '';
    const currentCat = new URLSearchParams(window.location.search).get('cat') || '';
  // compute counts per category
  const counts = (listings || []).reduce((acc, it) => { if(!it.category) return acc; acc[it.category] = (acc[it.category] || 0) + 1; return acc; }, {});
  const allBtn = document.createElement('button'); allBtn.className='category-tile' + (currentCat === '' ? ' active' : ''); allBtn.dataset.cat=''; allBtn.setAttribute('aria-pressed', currentCat === '');
  const allText = document.createTextNode('Все ');
  const allCount = document.createElement('span'); allCount.className = 'cat-count'; allCount.textContent = (listings ? listings.length : 0);
  allBtn.appendChild(allText); allBtn.appendChild(allCount); container.appendChild(allBtn);
  cats.forEach(c=>{ const b=document.createElement('button'); b.className='category-tile' + (currentCat === c ? ' active' : ''); b.dataset.cat=c; b.setAttribute('aria-pressed', currentCat === c); const ct = document.createTextNode(c + ' '); const cnt = document.createElement('span'); cnt.className='cat-count'; cnt.textContent = counts[c] || 0; b.appendChild(ct); b.appendChild(cnt); container.appendChild(b); });
    // tile click: load listings for this category via server query
    container.querySelectorAll('.category-tile').forEach(btn=>btn.addEventListener('click', ()=>{
      const cat = btn.dataset.cat || '';
      // update UI and history
      history.replaceState(null, '', cat ? ('?cat=' + encodeURIComponent(cat)) : window.location.pathname);
      document.getElementById('resultsGrid').hidden = false;
      document.getElementById('categoriesSection').hidden = true;
      document.getElementById('filtersPanel').hidden = false;
      // call server with category filter
      const q = '?category=' + encodeURIComponent(cat);
      loadAll(q);
    }));
  }

  function applyFilters(extra = {}){
    // Build server-side query parameters and call loadAll with a query string
    const inStock = document.getElementById('fInStock')?.checked;
    const onlyDiscount = document.getElementById('fDiscount')?.checked;
    const minRating = Number(document.getElementById('fRating')?.value || 0);
    const maxPrice = Number(document.getElementById('fMaxPrice')?.value || 0) || 0;
    const category = (extra.category !== undefined) ? extra.category : (document.querySelector('.category-tile.active')?.dataset.cat || '');

    const params = new URLSearchParams();
    if (category) params.set('category', category);
    if (inStock) params.set('in_stock', 'true');
    if (onlyDiscount) params.set('discount', 'true');
    if (minRating) params.set('minRating', String(minRating));
    if (maxPrice) params.set('maxPrice', String(maxPrice));

    const q = '?' + params.toString();
    // show results view
    document.getElementById('resultsGrid').hidden = false;
    document.getElementById('categoriesSection').hidden = true;
    document.getElementById('filtersPanel').hidden = false;
    // call server to fetch filtered results
    loadAll(q);
  }

  // Hook into loadAll to cache results and populate categories
  (function hookLoadAll(){
    const original = loadAll;
    window.loadAll = async function(q=''){
      // call original
      await original(q);
      // after load, cache results from DOM fetch - we fetch them again here to populate categories
      try{
        const res = await fetch('/api/listings' + (q?('?q='+encodeURIComponent(q)):'') );
        const data = await res.json();
        window.__latestListings = data || [];
        populateCategoryTiles(window.__latestListings);
      }catch(e){ console.warn('populate categories failed', e); }
    }
  })();

  // filter buttons
  document.getElementById('applyFilters')?.addEventListener('click', ()=> applyFilters({}));
  document.getElementById('clearFilters')?.addEventListener('click', ()=>{
    document.getElementById('fInStock').checked = false; document.getElementById('fDiscount').checked = false; document.getElementById('fRating').value='0'; document.getElementById('fMaxPrice').value='';
    document.querySelectorAll('.category-tile').forEach(b=>b.classList.remove('active'));
    document.querySelector('.category-tile[data-cat=""]')?.classList.add('active');
    document.getElementById('filtersPanel').hidden = true;
    applyFilters({ category: '' });
  });

  // handle browser back/forward so view updates when user navigates history
  window.addEventListener('popstate', (ev)=>{
    const paramsNow = new URLSearchParams(window.location.search);
    const catNow = paramsNow.get('cat') || '';
    const qNow = paramsNow.get('q') || '';
    if(!catNow && !qNow){
      // show categories
      document.getElementById('categoriesSection').hidden = false;
      document.getElementById('resultsGrid').hidden = true;
      // repopulate tiles from cached listings
      populateCategoryTiles(window.__latestListings || []);
    } else {
      // show results
      document.getElementById('categoriesSection').hidden = true;
      document.getElementById('resultsGrid').hidden = false;
      document.getElementById('filtersPanel').hidden = false;
      // if category specified, trigger load for that category
      if(catNow) loadAll('?q=' + encodeURIComponent(catNow));
      else loadAll(qNow);
    }
  });
</script>
</body>
</html>
