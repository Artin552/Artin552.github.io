<!-- listings.html
   –ü–æ–∫–∞–∑ –≤—Å–µ—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏–π —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é —Ñ–∏–ª—å—Ç—Ä–∞/–∫–∞—Ç–µ–≥–æ—Ä–∏–π.
-->
<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–°–ø–∏—Å–æ–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏–π ‚Äî –°—Ç—Ä–æ–π–ú–∞—Ä–∫–µ—Ç</title>
  <link rel="stylesheet" href="/css/styles.css">
  <script src="/js/auth.js"></script>
  <script src="/js/search.js"></script>
</head>
<body>
  <header class="header">
    <div class="container inner">
  <a class="logo" href="/index.html"><span class="mark"></span>–°—Ç—Ä–æ–π–ú–∞—Ä–∫–µ—Ç</a>
      <div style="flex:1; margin:0 16px;">
        <div class="search-bar">
          <input id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –æ–±—ä—è–≤–ª–µ–Ω–∏—è–º">
          <button class="btn" id="searchBtn">–ü–æ–∏—Å–∫</button>
        </div>
      </div>
      <div style="display:flex; gap:8px; align-items:center">
  <a href="/frontend/auth.html" class="btn secondary">–í—Ö–æ–¥</a>
  <a href="/frontend/add.html" class="btn">–î–æ–±–∞–≤–∏—Ç—å</a>
      </div>
    </div>
  </header>

  <main class="container" style="padding-top:18px">
    <!-- Categories tiles (moved from index) -->
    <section aria-label="–ö–∞—Ç–µ–≥–æ—Ä–∏–∏" class="categories-section" id="categoriesSection">
      <h2>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h2>
      <div id="categoryTiles" class="category-tiles">
        <!-- fallback tiles -->
      </div>
    </section>

    <section aria-label="–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏ —Ñ–∏–ª—å—Ç—Ä—ã">
      <div class="results-grid" id="resultsGrid" hidden>
        <aside class="filters-panel" id="filtersPanel" aria-label="–§–∏–ª—å—Ç—Ä—ã">
          <h3>–§–∏–ª—å—Ç—Ä—ã</h3>
          <div class="filter-group"><label><input type="checkbox" id="fInStock"> –í –Ω–∞–ª–∏—á–∏–∏</label></div>
          <div class="filter-group"><label><input type="checkbox" id="fDiscount"> –¢–æ–ª—å–∫–æ —Å–æ —Å–∫–∏–¥–∫–æ–π</label></div>
          <div class="filter-group"><label>–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–µ–π—Ç–∏–Ω–≥</label><select id="fRating"><option value="0">–õ—é–±–æ–π</option><option value="3">‚â• 3</option><option value="4">‚â• 4</option></select></div>
          <div class="filter-group"><label>–¶–µ–Ω–∞ (–º–∞–∫—Å)</label><input type="number" id="fMaxPrice" placeholder="–ú–∞–∫—Å–∏–º—É–º"></div>
          <div style="margin-top:12px; display:flex; gap:8px"><button class="btn" id="clearFilters">–°–±—Ä–æ—Å–∏—Ç—å</button><button class="btn primary" id="applyFilters">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button></div>
        </aside>
        <main class="results-main">
          <h2 class="sr">–û–±—ä—è–≤–ª–µ–Ω–∏—è</h2>
          <div id="listings" class="grid"></div>
        </main>
      </div>
    </section>
    <footer class="footer">¬© 2025 –°—Ç—Ä–æ–π–ú–∞—Ä–∫–µ—Ç</footer>
  </main>

<script>
  // –ï—Å–ª–∏ –≤ URL –µ—Å—Ç—å id ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–¥–Ω—É –∫–∞—Ä—Ç–æ—á–∫—É, –∏–Ω–∞—á–µ —Å–ø–∏—Å–æ–∫
  let __page = 1; const __limit = 12;
  async function loadAll(q=''){
    const root = document.getElementById('listings');
    
    // –ü—Ä–æ—Å—Ç–æ –∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤, –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º id
    const root2 = document.getElementById('listings');
    root2.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';
    
    try{
      const query = q ? (q.indexOf('?')===0? q + `&page=${__page}&limit=${__limit}` : ('?q='+encodeURIComponent(q) + `&page=${__page}&limit=${__limit}`)) : (`?page=${__page}&limit=${__limit}`);
      const res = await fetch('/api/listings' + query);
      const total = Number(res.headers.get('x-total-count') || 0);
      const data = await res.json();
      root2.innerHTML = '';
      data.forEach(item=>{
        const card = document.createElement('article'); card.className = 'card';
        const imgUrl = item.imagePath || `https://picsum.photos/seed/${encodeURIComponent(item.title)}/400/300`;
        const img = document.createElement('img'); img.className = 'thumb'; img.alt = item.title || ''; img.src = imgUrl;
        img.addEventListener('error', function onErr(){ img.removeEventListener('error', onErr); img.src = '/img/placeholder.svg'; });

        const meta = document.createElement('div'); meta.className = 'meta';
        const left = document.createElement('div');
        const title = document.createElement('div'); title.className = 'title'; title.textContent = item.title || '';
        const muted = document.createElement('div'); muted.className = 'muted small'; muted.textContent = item.category || '';
        left.appendChild(title); left.appendChild(muted);

        const right = document.createElement('div'); right.style.display = 'flex'; right.style.justifyContent = 'space-between'; right.style.alignItems = 'center';
        const price = document.createElement('div'); price.className = 'price'; price.textContent = item.price ? (item.price + ' ‚ÇΩ') : '–ü–æ –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–∏';
        const openA = document.createElement('a'); openA.className = 'btn secondary'; openA.href = '/frontend/product.html?id=' + encodeURIComponent(item.id); openA.textContent = '–û—Ç–∫—Ä—ã—Ç—å';
        right.appendChild(price); right.appendChild(openA);

        meta.appendChild(left); meta.appendChild(right);
        card.appendChild(img); card.appendChild(meta);
        root2.appendChild(card);
      });
      // pagination controls
      const pager = document.getElementById('pager');
      if(pager) pager.remove();
  const p = document.createElement('div'); p.id='pager'; p.style.textAlign='center'; p.style.marginTop='12px';
  const totalPages = Math.max(1, Math.ceil(total / __limit));
  const prevBtn = document.createElement('button'); prevBtn.className = 'btn'; prevBtn.id = 'prevPage'; prevBtn.type = 'button'; prevBtn.textContent = '‚Üê –ù–∞–∑–∞–¥'; if(__page<=1) prevBtn.disabled = true;
  const pageInfo = document.createElement('span'); pageInfo.style.margin = '0 8px'; pageInfo.textContent = `–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${__page} –∏–∑ ${totalPages}`;
  const nextBtn = document.createElement('button'); nextBtn.className = 'btn'; nextBtn.id = 'nextPage'; nextBtn.type = 'button'; nextBtn.textContent = '–î–∞–ª–µ–µ ‚Üí'; if(__page>=totalPages) nextBtn.disabled = true;
  p.appendChild(prevBtn); p.appendChild(pageInfo); p.appendChild(nextBtn);
  root2.parentNode.appendChild(p);
  prevBtn.addEventListener('click', ()=>{ if(__page>1){ __page--; loadAll(q); } });
  nextBtn.addEventListener('click', ()=>{ if(__page<totalPages){ __page++; loadAll(q); } });
    }catch(e){
      root2.innerText = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
    }
  }
  document.getElementById('searchBtn').addEventListener('click', ()=> loadAll(document.getElementById('searchInput').value.trim()));
  // –µ—Å–ª–∏ –≤ URL –µ—Å—Ç—å q ‚Äî –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ–∏—Å–∫ –∏–ª–∏ –µ—Å–ª–∏ –µ—Å—Ç—å cat ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é
  const params = new URLSearchParams(window.location.search);
  const q = params.get('q') || '';
  const catParam = params.get('cat') || '';
  if (q) document.getElementById('searchInput').value = q;
  document.getElementById('searchBtn').addEventListener('click', ()=>{
    const qv = document.getElementById('searchInput').value.trim();
    history.replaceState(null,'', qv?('?q='+encodeURIComponent(qv)) : '');
    // show results view
    document.getElementById('resultsGrid').hidden = false;
    document.getElementById('categoriesSection').hidden = true;
    loadAll(qv);
  });
  document.getElementById('searchInput').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ const qv=document.getElementById('searchInput').value.trim(); history.replaceState(null,'', qv?('?q='+encodeURIComponent(qv)): ''); document.getElementById('resultsGrid').hidden=false; document.getElementById('categoriesSection').hidden=true; loadAll(qv); } });

  // initial view: if cat param provided, show results for that category with filters on left
  if(catParam){
    document.getElementById('resultsGrid').hidden = false;
    document.getElementById('categoriesSection').hidden = true;
    // ensure filters panel visible
    document.getElementById('filtersPanel').hidden = false;
    // load listings where q=catParam
    loadAll('?q=' + encodeURIComponent(catParam));
  } else {
    // default: show only categories
    console.log('üìç Loading categories - no cat or q parameter');
    document.getElementById('resultsGrid').hidden = true;
    document.getElementById('categoriesSection').hidden = false;
    // Populate categories without rendering all listings
    (async ()=>{
      try{
        console.log('üì° Fetching /api/listings...');
        const res = await fetch('/api/listings');
        const data = await res.json();
        console.log('‚úÖ Got data:', data?.length, 'items');
        window.__latestListings = data || [];
        console.log('üéØ Calling populateCategoryTiles');
        populateCategoryTiles(window.__latestListings);
      }catch(e){ console.error('‚ùå failed to load categories', e); }
    })();
  }

  // --- Category + Filters helpers ---
  function populateCategoryTiles(listings){
    console.log('üîç populateCategoryTiles called with', listings?.length, 'listings');
    const container = document.getElementById('categoryTiles');
    if(!container) {
      console.error('‚ùå Container #categoryTiles not found!');
      return;
    }
    const cats = Array.from(new Set((listings||[]).map(it=>it.category).filter(Boolean)));
    console.log('üì¶ Found categories:', cats);
    
    if(cats.length === 0) {
      console.warn('‚ö†Ô∏è No categories found!');
      container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 20px;">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
      return;
    }
    
    container.innerHTML = '';
    
    // compute counts per category
    const counts = (listings || []).reduce((acc, it) => { if(!it.category) return acc; acc[it.category] = (acc[it.category] || 0) + 1; return acc; }, {});
    
    // Create category cards with images
    cats.forEach(c=>{ 
      // Find first product in this category for image
      const firstProduct = (listings || []).find(it=>it.category === c);
      const imgUrl = firstProduct?.imagePath || `https://picsum.photos/seed/${encodeURIComponent(c)}/300/200`;
      
      const card = document.createElement('article'); 
      card.className = 'category-card';
      card.style.cursor = 'pointer';
      card.style.borderRadius = '8px';
      card.style.overflow = 'hidden';
      card.style.backgroundColor = '#fff';
      card.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
      card.style.transition = 'transform 0.2s, box-shadow 0.2s';
      
      // Add hover effect
      card.addEventListener('mouseenter', function(){ 
        this.style.transform = 'translateY(-4px)'; 
        this.style.boxShadow = '0 8px 16px rgba(0,0,0,0.15)'; 
      });
      card.addEventListener('mouseleave', function(){ 
        this.style.transform = 'translateY(0)'; 
        this.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)'; 
      });
      
      // Image
      const img = document.createElement('img'); 
      img.className = 'thumb'; 
      img.alt = c; 
      img.src = imgUrl;
      img.style.width = '100%';
      img.style.height = '150px';
      img.style.objectFit = 'cover';
      img.addEventListener('error', function(){ img.src = '/img/placeholder.svg'; });
      
      // Category name and count
      const meta = document.createElement('div'); 
      meta.style.padding = '12px';
      meta.style.textAlign = 'center';
      
      const title = document.createElement('div'); 
      title.style.fontSize = '16px';
      title.style.fontWeight = 'bold';
      title.style.marginBottom = '4px';
      title.textContent = c;
      
      const count = document.createElement('div'); 
      count.style.fontSize = '14px';
      count.style.color = '#999';
      count.textContent = (counts[c] || 0) + ' —Ç–æ–≤–∞—Ä–æ–≤';
      
      meta.appendChild(title);
      meta.appendChild(count);
      card.appendChild(img);
      card.appendChild(meta);
      
      // Click handler
      card.addEventListener('click', ()=>{
        history.replaceState(null, '', '?cat=' + encodeURIComponent(c));
        document.getElementById('resultsGrid').hidden = false;
        document.getElementById('categoriesSection').hidden = true;
        document.getElementById('filtersPanel').hidden = false;
        const q = '?category=' + encodeURIComponent(c);
        loadAll(q);
      });
      
      container.appendChild(card);
    });
  }

  function applyFilters(extra = {}){
    // Build server-side query parameters and call loadAll with a query string
    const inStock = document.getElementById('fInStock')?.checked;
    const onlyDiscount = document.getElementById('fDiscount')?.checked;
    const minRating = Number(document.getElementById('fRating')?.value || 0);
    const maxPrice = Number(document.getElementById('fMaxPrice')?.value || 0) || 0;
    const category = (extra.category !== undefined) ? extra.category : (document.querySelector('.category-tile.active')?.dataset.cat || '');

    const params = new URLSearchParams();
    if (category) params.set('category', category);
    if (inStock) params.set('in_stock', 'true');
    if (onlyDiscount) params.set('discount', 'true');
    if (minRating) params.set('minRating', String(minRating));
    if (maxPrice) params.set('maxPrice', String(maxPrice));

    const q = '?' + params.toString();
    // show results view
    document.getElementById('resultsGrid').hidden = false;
    document.getElementById('categoriesSection').hidden = true;
    document.getElementById('filtersPanel').hidden = false;
    // call server to fetch filtered results
    loadAll(q);
  }

  // Hook into loadAll to cache results and populate categories
  (function hookLoadAll(){
    const original = loadAll;
    window.loadAll = async function(q=''){
      // call original
      await original(q);
      // after load, cache results from DOM fetch - we fetch them again here to populate categories
      try{
        const res = await fetch('/api/listings' + (q?('?q='+encodeURIComponent(q)):'') );
        const data = await res.json();
        window.__latestListings = data || [];
        populateCategoryTiles(window.__latestListings);
      }catch(e){ console.warn('populate categories failed', e); }
    }
  })();

  // filter buttons
  document.getElementById('applyFilters')?.addEventListener('click', ()=> applyFilters({}));
  document.getElementById('clearFilters')?.addEventListener('click', ()=>{
    document.getElementById('fInStock').checked = false; document.getElementById('fDiscount').checked = false; document.getElementById('fRating').value='0'; document.getElementById('fMaxPrice').value='';
    document.querySelectorAll('.category-tile').forEach(b=>b.classList.remove('active'));
    document.querySelector('.category-tile[data-cat=""]')?.classList.add('active');
    document.getElementById('filtersPanel').hidden = true;
    applyFilters({ category: '' });
  });

  // handle browser back/forward so view updates when user navigates history
  window.addEventListener('popstate', (ev)=>{
    const paramsNow = new URLSearchParams(window.location.search);
    const catNow = paramsNow.get('cat') || '';
    const qNow = paramsNow.get('q') || '';
    if(!catNow && !qNow){
      // show categories
      document.getElementById('categoriesSection').hidden = false;
      document.getElementById('resultsGrid').hidden = true;
      // repopulate tiles from cached listings
      populateCategoryTiles(window.__latestListings || []);
    } else {
      // show results
      document.getElementById('categoriesSection').hidden = true;
      document.getElementById('resultsGrid').hidden = false;
      document.getElementById('filtersPanel').hidden = false;
      // if category specified, trigger load for that category
      if(catNow) loadAll('?q=' + encodeURIComponent(catNow));
      else loadAll(qNow);
    }
  });
</script>
</body>
</html>
