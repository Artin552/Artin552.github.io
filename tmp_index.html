<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–°—Ç—Ä–æ–π–ú–∞—Ä–∫–µ—Ç ‚Äî –æ–±—ä—è–≤–ª–µ–Ω–∏—è</title>
  <link rel="stylesheet" href="frontend/css/styles.css">
    <script>
      // shared auth helper
    </script>
    <script src="frontend/js/auth.js"></script>
</head>
<body>
  <header class="header main-header" id="mainHeader">
    <div class="top_header header-inner container">
      <div class="logo-wrap">
        <a class="logo" href="index.html">
          <span class="brand">BUILDSTORE</span>
        </a>
        <div class="hammer" id="hammer" title="–°—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã–π –º–æ–ª–æ—Ç–æ–∫" aria-hidden="true">
          üî®
        </div>
      </div>

      <nav class="main-nav" id="mainNav">
        <a href="index.html">–ì–ª–∞–≤–Ω–∞—è</a>
        <a href="frontend/listings.html">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</a>
        <a href="#">–î–ª—è –±–∏–∑–Ω–µ—Å–∞</a>
        <a href="#">–î–æ—Å—Ç–∞–≤–∫–∞</a>
        <a href="#">–ö–æ–Ω—Ç–∞–∫—Ç—ã</a>
      </nav>

      <div class="header-actions">
        <div class="auth-links">
          <a href="frontend/auth.html" id="loginLink">–í—Ö–æ–¥</a>
          <a href="frontend/reg.html" id="regLink">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
        </div>

        <div class="cart" id="cartBtn" title="–ö–æ—Ä–∑–∏–Ω–∞">
          üõí <span class="cart-badge" id="cartBadge">0</span>
        </div>

        <a class="btn add-listing" href="frontend/add.html" id="addBtn">–î–æ–±–∞–≤–∏—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</a>
      </div>
    </div>
  </header>

  <!-- Hero video banner -->
  <div class="hero" id="hero">
    <video autoplay muted loop playsinline id="heroVideo">
      <source src="frontend/img/hero.mp4" type="video/mp4">
    </video>
    <div class="overlay"></div>
    <div class="hero-content">
      <h1>–í–∞—à —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã–π –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å –Ω–æ–≤–æ–≥–æ –ø–æ–∫–æ–ª–µ–Ω–∏—è</h1>
      <p class="hero-sub">–ë—ã—Å—Ç—Ä–æ. –ù–∞–¥–µ–∂–Ω–æ. –ë–µ–∑ –ø–æ—Å—Ä–µ–¥–Ω–∏–∫–æ–≤.</p>
      <div class="hero-stats">üì¶ 5000+ —Ç–æ–≤–∞—Ä–æ–≤ | üöö –î–æ—Å—Ç–∞–≤–∫–∞ –ø–æ –≤—Å–µ–π –†–æ—Å—Å–∏–∏ | üíº B2B &amp; B2C</div>
      <div class="search-box hero-search">
        <select id="heroCategory">
          <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
          <option>–ú–∞—Ç–µ—Ä–∏–∞–ª—ã</option>
          <option>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</option>
          <option>–¢–µ—Ö–Ω–∏–∫–∞</option>
        </select>
        <input id="heroQuery" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞...">
        <button id="heroFind" class="btn">üîç –ù–∞–π—Ç–∏</button>
      </div>
      <button id="watchVideoBtn" class="btn secondary" style="margin-top:12px; display:none;">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤–∏–¥–µ–æ</button>
    </div>
  </div>

  <main class="container" style="padding-top:18px">
    <!-- –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç: –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –∞–∫–∫–æ—Ä–¥–µ–æ–Ω (3 —à–∞–≥–∞) -->
    <section aria-label="–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç" class="how-it-works container" id="howItWorks">
      <h2>–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç</h2>
      <div class="accordion">
        <div class="accordion-item" data-step="1">
          <button class="accordion-head">
            <span class="icon icon-hammer" aria-hidden="true">üî®</span>
            <span class="head-title">–®–∞–≥ 1 ‚Äî –í—ã–±–∏—Ä–∞–µ—Ç–µ —Ç–æ–≤–∞—Ä</span>
            <span class="chev">‚ñæ</span>
          </button>
          <div class="accordion-body">
            <p>–í—ã–±–∏—Ä–∞–µ—Ç–µ –Ω—É–∂–Ω—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª –∏–ª–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –∏ –¥–æ–±–∞–≤–ª—è–µ—Ç–µ –≤ –∫–æ—Ä–∑–∏–Ω—É. –ú—ã –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö –ø—Ä–æ–¥–∞–≤—Ü–æ–≤ –∏ –Ω–∞–ª–∏—á–∏–µ –Ω–∞ —Å–∫–ª–∞–¥–µ.</p>
          </div>
        </div>

        <div class="accordion-item" data-step="2">
          <button class="accordion-head">
            <span class="icon icon-truck" aria-hidden="true">üöö</span>
            <span class="head-title">–®–∞–≥ 2 ‚Äî –û—Ñ–æ—Ä–º–ª—è–µ—Ç–µ –¥–æ—Å—Ç–∞–≤–∫—É</span>
            <span class="chev">‚ñæ</span>
          </button>
          <div class="accordion-body">
            <p>–í—ã–±–∏—Ä–∞–µ—Ç–µ —É–¥–æ–±–Ω—ã–π —Å–ø–æ—Å–æ–± –¥–æ—Å—Ç–∞–≤–∫–∏ –∏–ª–∏ —Å–∞–º–æ–≤—ã–≤–æ–∑. –ú—ã –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ä–æ–∫–∏ –∏ —Å—Ç–æ–∏–º–æ—Å—Ç—å —Å—Ä–∞–∑—É.</p>
          </div>
        </div>

        <div class="accordion-item" data-step="3">
          <button class="accordion-head">
            <span class="icon icon-check" aria-hidden="true">‚úÖ</span>
            <span class="head-title">–®–∞–≥ 3 ‚Äî –ü–æ–ª—É—á–∞–µ—Ç–µ –∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç–µ</span>
            <span class="chev">‚ñæ</span>
          </button>
          <div class="accordion-body">
            <p>–ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –≤—ã –æ—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç–µ —Ç–æ–≤–∞—Ä –∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –æ—Ñ–æ—Ä–º–ª—è–µ—Ç–µ –≤–æ–∑–≤—Ä–∞—Ç. –û—Å—Ç–∞–≤–ª—è–µ—Ç–µ –æ—Ç–∑—ã–≤ –∏ –ø–æ–º–æ–≥–∞–µ—Ç–µ –¥—Ä—É–≥–∏–º.</p>
          </div>
        </div>
      </div>
    </section>
    <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ —Ñ–∏–ª—å—Ç—Ä—ã –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã –≤ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å–ø–∏—Å–∫–∞ (listings.html) -->

    <footer class="footer">
      ¬© 2025 –°—Ç—Ä–æ–π–ú–∞—Ä–∫–µ—Ç ‚Äî —É—á–µ–±–Ω—ã–π –ø—Ä–æ–µ–∫—Ç. –í—Å–µ –ø—Ä–∞–≤–∞ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∞—Ç –∞–≤—Ç–æ—Ä—É –ø—Ä–æ–µ–∫—Ç–∞.
    </footer>
  </main>

  <script>
    // üîπ –ü–æ–∫–∞–∑—ã–≤–∞–µ–º email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤–º–µ—Å—Ç–æ –∫–Ω–æ–ø–∫–∏ –≤—Ö–æ–¥–∞ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –≤—ã—Ö–æ–¥
    // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: —Ä–∞–Ω–µ–µ —Å–∫—Ä–∏–ø—Ç –æ–∂–∏–¥–∞–ª —ç–ª–µ–º–µ–Ω—Ç—ã —Å id=userSection/authBtn, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ —Ä–∞–∑–º–µ—Ç–∫–µ.
    document.addEventListener('DOMContentLoaded', () => {
      const authLinksContainer = document.querySelector('.auth-links');
      const loginLink = document.getElementById('loginLink');
      const regLink = document.getElementById('regLink');
      const userEmail = sessionStorage.getItem('userEmail');

      if (userEmail && authLinksContainer) {
        // –°–∫—Ä—ã–≤–∞–µ–º —Å—Å—ã–ª–∫–∏ –≤—Ö–æ–¥/—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
        if (loginLink) loginLink.style.display = 'none';
        if (regLink) regLink.style.display = 'none';

        // –°–æ–∑–¥–∞—ë–º —Å—Å—ã–ª–∫—É –Ω–∞ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç
        const profileLink = document.createElement('a');
        profileLink.className = 'btn secondary';
        profileLink.href = 'frontend/dashboard.html';
        profileLink.textContent = userEmail;

        // –ö–Ω–æ–ø–∫–∞ –≤—ã—Ö–æ–¥–∞
        const logoutBtn = document.createElement('button');
        logoutBtn.className = 'btn';
        logoutBtn.textContent = '–í—ã–π—Ç–∏';
        logoutBtn.addEventListener('click', () => {
          sessionStorage.removeItem('userEmail');
          sessionStorage.removeItem('token');
          // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –æ—á–∏—Å—Ç–∏—Ç—å localStorage –µ—Å–ª–∏ —Ç–∞–º –µ—Å—Ç—å —Ç–æ–∫–µ–Ω
          localStorage.removeItem('token');
          window.location.reload();
        });

        authLinksContainer.appendChild(profileLink);
        authLinksContainer.appendChild(logoutBtn);
      }
    });

    // üîπ –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–π
    async function loadListings(q = '') {
      // store latest raw results so filters can operate client-side
      window.__latestListings = window.__latestListings || [];
      const root = document.getElementById('listings');
      // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–∏–Ω–∏-–∞–Ω–∏–º–∞—Ü–∏—é –∑–∞–≥—Ä—É–∑–∫–∏
      root.innerHTML = `
        <div style="display:flex;justify-content:center;padding:24px;">
          <div class="boxes" aria-hidden="true">
            <div class="box"><div></div><div></div><div></div><div></div></div>
            <div class="box"><div></div><div></div><div></div><div></div></div>
            <div class="box"><div></div><div></div><div></div><div></div></div>
            <div class="box"><div></div><div></div><div></div><div></div></div>
          </div>
        </div>
      `;
      try {
  const res = await fetch('/api/listings' + (q ? ('?q=' + encodeURIComponent(q)) : ''));
        const data = await res.json();
        if (!Array.isArray(data)) {
          root.innerText = '–û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –æ—Ç–≤–µ—Ç–∞';
          return;
        }
        if (data.length === 0) {
          root.innerHTML = '<div>–û–±—ä—è–≤–ª–µ–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç.</div>';
          return;
        }
        root.innerHTML = '';
  // cache results
  window.__latestListings = data;

  data.forEach((item, idx) => {
          const card = document.createElement('article');
          card.className = 'card';
          // preview: prefer video if provided, otherwise image
          const hasVideo = item.videoPath || item.videoBase64;
          const imgUrl = item.imagePath || (item.imageBase64 ? (`data:image/*;base64,${item.imageBase64}`) : `https://picsum.photos/seed/${encodeURIComponent(item.title)}/400/300`);
          const videoUrl = item.videoPath || (item.videoBase64 ? (`data:video/mp4;base64,${item.videoBase64}`) : '');
          const priceText = item.price ? (item.price + ' ‚ÇΩ') : '–¶–µ–Ω–∞ –ø–æ –¥–æ–≥–æ–≤–æ—Ä—ë–Ω–Ω–æ—Å—Ç–∏';
          const discount = item.discount || 0; // optional field
          const rating = item.rating || 0;
          const reviews = item.reviewsCount || 0;
          const inStock = (item.in_stock === undefined) ? (item.stock ? true : false) : Boolean(item.in_stock);
          const isHot = item.is_hot || (item.tags && item.tags.indexOf('hot') !== -1);
          card.innerHTML = `
            <div class="preview">
              ${hasVideo ? (`<video class="preview-video" muted loop playsinline preload="metadata"><source src="${videoUrl}" type="video/mp4"></video>`) : (`<img class="thumb" src="${imgUrl}" alt="${item.title}">`)}
              ${discount ? `<div class="discount">-${discount}%</div>` : ''}
              ${isHot ? `<div class="hot-badge">üî• –•–∏—Ç –ø—Ä–æ–¥–∞–∂</div>` : ''}
            </div>
            <div class="meta">
              <div>
                <div class="title">${item.title}</div>
                <div class="muted small">${item.category || ''} ‚Ä¢ ${item.location || ''}</div>
                <div class="rating">‚≠ê ${rating} (${reviews})</div>
              </div>
              <div style="display:flex; flex-direction:column; align-items:flex-end; gap:8px;">
                <div style="display:flex; gap:8px; align-items:center;">
                  <div class="price">${priceText}</div>
                </div>
                <div class="stock">${inStock ? '‚úÖ –í –Ω–∞–ª–∏—á–∏–∏' : '‚ùå –ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏'}</div>
                <a class="btn open-btn" href="frontend/listings.html?id=${item.id}">–û—Ç–∫—Ä—ã—Ç—å ‚Üí</a>
              </div>
            </div>
          `;
          card.classList.add('slide-in');
          root.appendChild(card);
          // add animate-in with small stagger
          setTimeout(()=> card.classList.add('animate-in'), 80 * idx + 50);
        });
        // populate category tiles based on results (unique categories)
        populateCategoryTiles(window.__latestListings);
      } catch (e) {
        root.innerText = '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏—è.';
        console.error(e);
      }
    }

    // Populate category tiles dynamically
    function populateCategoryTiles(listings){
      const container = document.getElementById('categoryTiles');
      if(!container) return;
      const cats = Array.from(new Set(listings.map(it => it.category).filter(Boolean)));
      // keep existing default tiles if any; clear and render canonical set
      container.innerHTML = '';
      // Add an '–í—Å–µ' tile
      const allBtn = document.createElement('button');
      allBtn.className = 'category-tile active';
      allBtn.dataset.cat = '';
      allBtn.textContent = '–í—Å–µ';
      container.appendChild(allBtn);
      cats.forEach(c => {
        const b = document.createElement('button');
        b.className = 'category-tile';
        b.dataset.cat = c;
        b.textContent = c;
        container.appendChild(b);
      });
      // attach events
      container.querySelectorAll('.category-tile').forEach(btn => btn.addEventListener('click', onCategoryTileClick));
    }

    function onCategoryTileClick(e){
      const btn = e.currentTarget;
      const cat = btn.dataset.cat || '';
      // set active
      document.querySelectorAll('.category-tile').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      // show filtersPanel when a specific category selected
      const panel = document.getElementById('filtersPanel');
      if(panel) panel.hidden = !cat;
      // apply client-side filter
      applyFilters({ category: cat });
    }

    // Apply filters to cached listings and re-render results
    function applyFilters(extra = {}){
      let list = (window.__latestListings || []).slice();
      const inStock = document.getElementById('fInStock')?.checked;
      const onlyDiscount = document.getElementById('fDiscount')?.checked;
      const minRating = Number(document.getElementById('fRating')?.value || 0);
      const maxPrice = Number(document.getElementById('fMaxPrice')?.value || 0) || 0;
      const category = (extra.category !== undefined) ? extra.category : (document.querySelector('.category-tile.active')?.dataset.cat || '');

      if(category) list = list.filter(i => (i.category || '') === category);
      if(inStock) list = list.filter(i => (i.in_stock === undefined) ? Boolean(i.stock) : Boolean(i.in_stock));
      if(onlyDiscount) list = list.filter(i => Number(i.discount) > 0);
      if(minRating) list = list.filter(i => Number(i.rating || 0) >= minRating);
      if(maxPrice) list = list.filter(i => Number(i.price || 0) <= maxPrice);

      // render filtered list (reuse rendering logic but simple)
      const root = document.getElementById('listings');
      root.innerHTML = '';
      if(list.length === 0){ root.innerHTML = '<div>–ü–æ–¥—Ö–æ–¥—è—â–∏—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</div>'; return; }
      list.forEach((item, idx) => {
        const card = document.createElement('article');
        card.className = 'card';
        const hasVideo = item.videoPath || item.videoBase64;
        const imgUrl = item.imagePath || (item.imageBase64 ? (`data:image/*;base64,${item.imageBase64}`) : `https://picsum.photos/seed/${encodeURIComponent(item.title)}/400/300`);
        const videoUrl = item.videoPath || (item.videoBase64 ? (`data:video/mp4;base64,${item.videoBase64}`) : '');
        const priceText = item.price ? (item.price + ' ‚ÇΩ') : '–¶–µ–Ω–∞ –ø–æ –¥–æ–≥–æ–≤–æ—Ä—ë–Ω–Ω–æ—Å—Ç–∏';
        const discount = item.discount || 0;
        const rating = item.rating || 0;
        const reviews = item.reviewsCount || 0;
        const inStock = (item.in_stock === undefined) ? (item.stock ? true : false) : Boolean(item.in_stock);
        const isHot = item.is_hot || (item.tags && item.tags.indexOf('hot') !== -1);
        card.innerHTML = `
          <div class="preview">
            ${hasVideo ? (`<video class="preview-video" muted loop playsinline preload="metadata"><source src="${videoUrl}" type="video/mp4"></video>`) : (`<img class="thumb" src="${imgUrl}" alt="${item.title}">`)}
            ${discount ? `<div class="discount">-${discount}%</div>` : ''}
            ${isHot ? `<div class="hot-badge">üî• –•–∏—Ç –ø—Ä–æ–¥–∞–∂</div>` : ''}
          </div>
          <div class="meta">
            <div>
              <div class="title">${item.title}</div>
              <div class="muted small">${item.category || ''} ‚Ä¢ ${item.location || ''}</div>
              <div class="rating">‚≠ê ${rating} (${reviews})</div>
            </div>
            <div style="display:flex; flex-direction:column; align-items:flex-end; gap:8px;">
              <div style="display:flex; gap:8px; align-items:center;">
                <div class="price">${priceText}</div>
              </div>
              <div class="stock">${inStock ? '‚úÖ –í –Ω–∞–ª–∏—á–∏–∏' : '‚ùå –ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏'}</div>
              <a class="btn open-btn" href="frontend/listings.html?id=${item.id}">–û—Ç–∫—Ä—ã—Ç—å ‚Üí</a>
            </div>
          </div>
        `;
        root.appendChild(card);
        setTimeout(()=> card.classList.add('animate-in'), 80 * idx + 50);
      });
    }

    // filters actions
    const applyBtn = document.getElementById('applyFilters');
    if(applyBtn) applyBtn.addEventListener('click', ()=> applyFilters({}));
    const clearBtn = document.getElementById('clearFilters');
    if(clearBtn) clearBtn.addEventListener('click', ()=>{
      document.getElementById('fInStock').checked = false;
      document.getElementById('fDiscount').checked = false;
      document.getElementById('fRating').value = '0';
      document.getElementById('fMaxPrice').value = '';
      // reset category to all
      document.querySelectorAll('.category-tile').forEach(b=>b.classList.remove('active'));
      document.querySelector('.category-tile[data-cat=""]')?.classList.add('active');
      document.getElementById('filtersPanel').hidden = true;
      applyFilters({ category: '' });
    });

    // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Enter –≤ –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞ hero (–≥–ª–∞–≤–Ω—ã–π –ø–æ–∏—Å–∫)
    const heroQueryInput = document.getElementById('heroQuery');
    if (heroQueryInput){
      heroQueryInput.addEventListener('keydown', (e)=>{
        if(e.key === 'Enter'){
          const cat = document.getElementById('heroCategory').value || '';
          const qv = heroQueryInput.value.trim() || '';
          const q = [cat, qv].filter(Boolean).join(' ');
          history.replaceState(null, '', q ? ('?q=' + encodeURIComponent(q)) : window.location.pathname);
          loadListings(q);
        }
      });
    }

    // –ü–æ –∫–ª–∏–∫—É –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ‚Äî –¥–µ–ª–∞–µ–º –ø–æ–∏—Å–∫ –ø–æ –Ω–µ–π (–∏—Å–ø–æ–ª—å–∑—É–µ–º heroQuery –≤–º–µ—Å—Ç–æ —É–¥–∞–ª—ë–Ω–Ω–æ–≥–æ searchInput)
    document.querySelectorAll('.category').forEach(el => {
      el.addEventListener('click', () => {
        const q = el.textContent.trim();
        const heroQ = document.getElementById('heroQuery');
        if(heroQ) heroQ.value = q;
        history.replaceState(null, '', '?q=' + encodeURIComponent(q));
        loadListings(q);
      });
    });

    // –ï—Å–ª–∏ –≤ URL –µ—Å—Ç—å q –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ ‚Äî –∑–∞–ø–æ–ª–Ω–∏–º heroQuery –∏ –≤—ã–ø–æ–ª–Ω–∏–º –ø–æ–∏—Å–∫
    const initParams = new URLSearchParams(window.location.search);
    const initQ = initParams.get('q');
    if (initQ) {
      const heroQuery = document.getElementById('heroQuery');
      if(heroQuery) heroQuery.value = initQ;
      loadListings(initQ);
    }

    // üîπ –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    // –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –≤–æ–∑—å–º—ë–º q –∏–∑ URL –µ—Å–ª–∏ –µ—Å—Ç—å
    const startParams = new URLSearchParams(window.location.search);
    const startQ = startParams.get('q') || '';
    if(startQ) {
      const heroQuery = document.getElementById('heroQuery');
      if(heroQuery) heroQuery.value = startQ;
    }
    loadListings(startQ);

    // header interactions
    const headerEl = document.getElementById('mainHeader');
    let lastScroll = 0;
    window.addEventListener('scroll', ()=>{
      const y = window.scrollY;
      if(y > 60) headerEl.classList.add('shrink'); else headerEl.classList.remove('shrink');
      lastScroll = y;
    });

    // hammer hover: small bounce when hovered
    const hammer = document.getElementById('hammer');
    if(hammer){
      hammer.addEventListener('mouseenter', ()=>{ hammer.style.transform = 'translateY(-2px) scale(1.08)'; });
      hammer.addEventListener('mouseleave', ()=>{ hammer.style.transform = ''; });
    }

    // cart add demo: animation when cartBadge increments
    const cartBadge = document.getElementById('cartBadge');
    const cartBtn = document.getElementById('cartBtn');
    function addToCartDemo(){
      let n = Number(cartBadge.textContent || '0'); n++; cartBadge.textContent = n; cartBtn.classList.add('added'); setTimeout(()=>cartBtn.classList.remove('added'),700);
    }
    // For demo: clicking the cart will simulate adding
    cartBtn.addEventListener('click', ()=> addToCartDemo());

    // Hero search wiring: combine category + query, call loadListings and animate cards
    const heroFind = document.getElementById('heroFind');
    if(heroFind){
      heroFind.addEventListener('click', ()=>{
        const cat = document.getElementById('heroCategory').value || '';
        const qv = document.getElementById('heroQuery').value.trim() || '';
        const qstr = [cat, qv].filter(Boolean).join(' ');
        // animate existing cards out
        document.querySelectorAll('#listings .card').forEach((c,i)=>{ c.classList.add('slide-in'); setTimeout(()=>c.remove(), 350 + i*60); });
        loadListings(qstr);
      });
    }

    // Watch video button for mobile (opens video in a new small modal)
    const watchBtn = document.getElementById('watchVideoBtn');
    if(watchBtn){
      watchBtn.addEventListener('click', ()=>{
        const vsrc = document.getElementById('heroVideo').querySelector('source').src;
        const w = window.open('', 'heroVideo', 'width=800,height=460');
        w.document.write(`<video src="${vsrc}" controls autoplay style="width:100%"></video>`);
      });
    }

    // Ensure hero video stays looping and resumes when possible
    (function ensureHeroVideoLoop(){
      const heroVideo = document.getElementById('heroVideo');
      if(!heroVideo) return;
      // enforce desirable attributes
      try { heroVideo.muted = true; } catch(e){}
      try { heroVideo.loop = true; } catch(e){}
      try { heroVideo.playsInline = true; } catch(e){}
      try { heroVideo.preload = 'auto'; } catch(e){}

      // If the browser somehow stops the loop, restart on ended
      heroVideo.addEventListener('ended', ()=>{
        try{ heroVideo.currentTime = 0; heroVideo.play().catch(()=>{}); }catch(e){}
      });

      // When tab becomes visible again, try to play (some browsers pause in background)
      document.addEventListener('visibilitychange', ()=>{
        if(!document.hidden){
          heroVideo.play().catch(()=>{});
        }
      });

      // If video is paused unexpectedly while page visible, attempt to resume
      heroVideo.addEventListener('pause', ()=>{
        if(!document.hidden){
          setTimeout(()=> heroVideo.play().catch(()=>{}), 150);
        }
      });

      // On stall or error try to reload and play
      heroVideo.addEventListener('stalled', ()=>{ heroVideo.load(); heroVideo.play().catch(()=>{}); });
      heroVideo.addEventListener('error', ()=>{ setTimeout(()=>{ heroVideo.load(); heroVideo.play().catch(()=>{}); }, 300); });

      // Pause other non-essential videos (e.g. listing previews) to reduce autoplay throttling
      setTimeout(()=>{
        document.querySelectorAll('video').forEach(v => {
          if(v === heroVideo) return;
          // only pause preview videos created for cards
          if(v.classList.contains('preview-video')){
            try{ v.pause(); }catch(e){}
          }
        });
        // try to play hero after briefly pausing others
        heroVideo.play().catch(()=>{});
      }, 250);
    })();

    // –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç ‚Äî –∞–∫–∫–æ—Ä–¥–µ–æ–Ω
    (function setupAccordion(){
      const items = document.querySelectorAll('.accordion-item');
      items.forEach(it => {
        const head = it.querySelector('.accordion-head');
        const body = it.querySelector('.accordion-body');
        const icon = it.querySelector('.icon');
        head.addEventListener('click', ()=>{
          const isOpen = body.classList.contains('open');
          // close all
          document.querySelectorAll('.accordion-body.open').forEach(b=>{ b.classList.remove('open'); b.style.maxHeight = null; });
          document.querySelectorAll('.accordion-item .icon.open').forEach(ic=>ic.classList.remove('open'));
          if(!isOpen){
            body.classList.add('open');
            body.style.maxHeight = body.scrollHeight + 'px';
            if(icon) icon.classList.add('open');
            // special icon animation for hammer on step 1
            if(it.dataset.step === '1'){
              icon.classList.add('swing');
              setTimeout(()=> icon.classList.remove('swing'), 900);
            }
          }
        });
      });
    })();
  </script>
  
</body>
</html>
